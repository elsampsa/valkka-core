<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Valkka: Caching Frames</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Valkka
   &#160;<span id="projectnumber">1.6.1</span>
   </div>
   <div id="projectbrief">OpenSource Video Management</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Caching Frames </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>FileCacherThread::run</p>
<pre class="fragment">walltime == wallclock time 

target_mstimestamp_ = 0 
    current target frametime, transformed from current walltime : stopStreams, seekStreams, run

next = NULL 
    points to next frame : run
    
reftime = 0 
    value for transforming frametime &lt;-&gt; walltime : playStreams, seekStreams, run

next_mstimestamp = 0 : run
    timestamp of the next frame in wallclock time

    
while True:
    
    if next != NULL and reftime &gt; 0:
        # next frame exists and we can get it's wallclock time
        next_mstimestamp = next.mstimestamp + reftime # from frametime to walltime
        # =&gt; calculate timeout to the next frame
        timeout = ..
    else:
        timeout = default_timeout
    
    f = infifo.read(timeout)
    
    # there's either a frame or this was a timeout
    
    if TIMEOUT:
        pass
        
    elif GOT_FRAME:
        
        if f is signal:
            # handle the signal =&gt; seekStreams, playStreams, stopStreams
            
        elif f is marker:
            if marker == TM_START # transmission start
                # do nothing .. frames are flowing to tmp cache
                
            elif marker == TM_END # transmission end
                switchCache() # tmp cache becomes the play_cache
                next = NULL
                if target_mstimestamp_ &lt;= 0: # no seek time set yet
                    # this can happen: seek has not yet called, but block transmission has been requested
                    # that's fixed with the next seek call
                    print WARNING
                else:
                    if state == SEEK or state == STOP:
                        i = play_cache-&gt;keySeek
                    elif state == PLAY:
                        i = play_cache-&gt;seek
                    else:
                        print WARNING
                        
                    if seek succeeded:
                        next = play_cache.pullNextFrame()
                        
                    if next != None:
                        walltime = getCurrentMsTimestamp();
                        reftime = walltime - target_mstimestamp_; # match walltime to target frametime
                        
        
    # frame handled
    
    mstime = getCurrentMsTimestamp() # update current time
    
    if reftime &gt; 0 and &amp; state == PLAY: # walltime get's updated constantly
        walltime = mstime
        target_mstimestamp_ = walltime - reftime; # update current frametime
            
    # FRAME PULL LOOP: pull all necessary frames from the cache
    while next != NULL and (next_mstimestamp - walltime) &lt;= 0:
        
        if reftime == 0: # no reftime set .. take it from the first frame
            reftime = mstime - target_mstimestamp_
            stopStreams() # state =&gt; STOP, send SetupFrames
        
        # create &amp; send a SetupFrame for decoder init if necessary
        ...
        
        # send frame to correct framefilter with this timestamp:
        frame.mstimestamp = next.mstimestamp + reftime # from frametime to walltime
        
        next = play_cache.pullNextFrame()
        if next != NULL:
            next_mstimestamp = next.mstimestamp + reftime # from frametime to walltime
            
        if next == NULL or next_mstimestamp - walltime &gt; 0: # while loop is about to break
            if state == SEEK
                stopStreams() # state =&gt; STOP, send SetupFrames
    
    # handle signals etc


- seek sets the reftime
- play : stream's been stopped, so there's a fixed target_mstimestamp_ =&gt; get reftime == walltime &lt;-&gt; frametime mapping from there
- stop : stream's been playing / seeking, so there's reftime (wall-time &lt;-&gt; frametime mapping) =&gt; get target_mstimestamp_ from walltime

stopStreams:
    if reftime &gt; 0:
        walltime = getCurrentMsTimestamp()
        target_mstimestamp_ = walltime - reftime # get current frametime from walltime
        
playStreams:
    if target_mstimestamp_ &gt; 0:
        walltime = getCurrentMsTimestamp()
        reftime = walltime - target_mstimestamp_ # get reftime from current frametime
        
seekStreams(mstimestamp_): # if target frame time mstimestamp_ is found in play_cache, do immediate seek, otherwise, set reftime = 0
    target_mstimestamp_ = mstimestamp_
    if play_cache has the target frame, then:
        walltime = getCurrentMsTimestamp()
        reftime = walltime - target_mstimestamp_
    else:
        reftime = 0</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
