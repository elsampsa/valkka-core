<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Valkka: filesystem cpp / Python callbacks</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Valkka
   &#160;<span id="projectnumber">1.5.4</span>
   </div>
   <div id="projectbrief">OpenSource Video Management</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">filesystem cpp / Python callbacks </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="classValkkaFS.html" title="Book-keeping for ValkkaFS.">ValkkaFS</a> is using both cpp-to-python and python-to-cpp calls</p>
<p>This can get tricky, and care must be taken to avoid nasty deadlocks due to the Python Global Interpreter Lock (GIL)</p>
<p>The cpp part of the code can decide to call some python code, that has been defined in the main thread Python part. This is done by the cpp code "autonomously" and is not initiated from the python side. (*)</p>
<p>Python part might evoke some cpp code. (**)</p>
<p>Special care must be taken with "callback cascades" that start from cpp and end up back to the cpp side again.</p>
<p>The acquisition and release of GIL is illustrated in the following graph. </p><pre class="fragment">(*)      = callback from cpp to Python
(**)     = callback from Python to cpp
|        = the instance holding the GIL
DEADLOCK = example deadlock situations

A program using both (*) and (**) callbacks:


            main thread (Python)           cpp thread
            
               |
               |
               |
                                           | acquire GIL (*) 
                                           | - call python method, defined at main thread
                                           | release GIL
               |
               |
               |
                                           | acquire GIL (*)
                                           | - call python method, defined at main thread
                                           |   - that python method might call cpp code which tries to acquire GIL =&gt; DEADLOCK!
                                           | release GIL
            
               |
               | 
               | call swig-wrapped   
               | cpp method (**)           do not acquire GIL           
               |                           as it's being hold by the main thread
               |                           return
               |
                                           | acquire GIL (*)
                                           | - call python method, defined at main thread
                                           | release GIL </pre><pre class="fragment">            main thread (Python)           ValkkaFSWriterThread    
            
              |
              |
                                           | acquire GIL
                                           | - call ValkkaFSWriterThread::pyfunc
                                           |   - In the python side, this is set to valkka.api2.valkkafs.new_block_cb__
                                           |   - .. which in turn continues the callback-cascade into ValkkaFS::setArrayCall
                                           | release GIL
              |
              |
            
              | requestStopCall           requestStopCall (cpp side)
              | (python side)             - sends message to thread's message queue
              |                           - returns immediately
             
              |                           exits thread's running loop
               
              | waitStopCall              preJoin 
              |                           =&gt; saveCurrentBlock 
              |                              =&gt; valkkaFS::writeBlock 
              |                                 - should not acquire GIL as this has been 
              |                                   requested from the python side
              |                           thread join &amp; exit
            
            --------------------------------------------------
            
                                           | CacheStream::run
                                           | pyfunc
                                                =&gt; valkka.api2.ValkkaFSManager.timeCallback__(mstime)
                                                    =&gt; valkka.api2.ValkkaFSManager.stop()
                                                        =&gt; ValkkaFSWriterThread::stopStreamsCall() # this makes any sense?
                                                - it's ok to call other thread's functions, as long as they don't return the callback chain to python</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
